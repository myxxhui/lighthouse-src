"use strict";
import { Fragment, jsx, jsxs } from "react/jsx-runtime";
import { useEffect } from "react";
import { Card, Descriptions, Button, Space, Alert, Spin } from "antd";
import { LoadingOutlined } from "@ant-design/icons";
import { useNavigate, useSearchParams } from "react-router-dom";
import DrilldownNavigator from "@/components/DrilldownNavigator";
import EfficiencyChart from "@/components/EfficiencyChart";
import StatusIndicator from "@/components/StatusIndicator";
import { useAppStore } from "@/store";
const DrilldownPage = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const {
    currentDrilldownItem,
    loadingDrilldown,
    errorDrilldown,
    fetchDrilldownData,
    clearDrilldownPath
  } = useAppStore();
  const type = searchParams.get("type");
  const id = searchParams.get("id");
  useEffect(() => {
    if (type && id) {
      fetchDrilldownData(type, id);
    }
    return () => {
      clearDrilldownPath();
    };
  }, [type, id, fetchDrilldownData, clearDrilldownPath]);
  const handleBack = () => {
    navigate(-1);
  };
  const handleHome = () => {
    navigate("/");
  };
  const renderDrilldownContent = () => {
    if (loadingDrilldown) {
      return /* @__PURE__ */ jsxs("div", { style: { textAlign: "center", padding: "40px" }, children: [
        /* @__PURE__ */ jsx(Spin, { indicator: /* @__PURE__ */ jsx(LoadingOutlined, { spin: true }) }),
        /* @__PURE__ */ jsx("p", { children: "\u52A0\u8F7D\u4E2D..." })
      ] });
    }
    if (errorDrilldown) {
      return /* @__PURE__ */ jsx(
        Alert,
        {
          message: "\u52A0\u8F7D\u94BB\u53D6\u6570\u636E\u5931\u8D25",
          description: errorDrilldown,
          type: "error",
          showIcon: true,
          action: /* @__PURE__ */ jsx(Button, { type: "primary", onClick: () => type && id && fetchDrilldownData(type, id), children: "\u91CD\u8BD5" })
        }
      );
    }
    if (!currentDrilldownItem) {
      return /* @__PURE__ */ jsx("div", { style: { textAlign: "center", padding: "40px" }, children: /* @__PURE__ */ jsx("p", { children: "\u6682\u65E0\u6570\u636E" }) });
    }
    const getTypeName = (itemType) => {
      switch (itemType) {
        case "namespace":
          return "\u547D\u540D\u7A7A\u95F4";
        case "node":
          return "\u8282\u70B9";
        case "workload":
          return "\u5DE5\u4F5C\u8D1F\u8F7D";
        case "pod":
          return "Pod";
        default:
          return itemType;
      }
    };
    let status = "healthy";
    if (currentDrilldownItem.efficiency < 50) {
      status = "critical";
    } else if (currentDrilldownItem.efficiency < 70) {
      status = "warning";
    }
    return /* @__PURE__ */ jsxs(Fragment, { children: [
      /* @__PURE__ */ jsx(Card, { title: `${getTypeName(currentDrilldownItem.type)}: ${currentDrilldownItem.name}`, children: /* @__PURE__ */ jsxs(Descriptions, { column: { xs: 1, sm: 2, md: 3 }, bordered: true, children: [
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "ID", children: currentDrilldownItem.id }),
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "\u7C7B\u578B", children: getTypeName(currentDrilldownItem.type) }),
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "\u6210\u672C (\xA5)", children: currentDrilldownItem.cost.toLocaleString() }),
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "\u53EF\u4F18\u5316\u7A7A\u95F4 (\xA5)", children: currentDrilldownItem.optimizableSpace.toLocaleString() }),
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "\u6548\u7387\u5206", children: /* @__PURE__ */ jsxs(Space, { children: [
          /* @__PURE__ */ jsx(
            EfficiencyChart,
            {
              efficiency: currentDrilldownItem.efficiency,
              size: 40,
              showLabel: false
            }
          ),
          /* @__PURE__ */ jsxs("span", { children: [
            currentDrilldownItem.efficiency,
            "%"
          ] })
        ] }) }),
        /* @__PURE__ */ jsx(Descriptions.Item, { label: "\u5065\u5EB7\u72B6\u6001", children: /* @__PURE__ */ jsx(StatusIndicator, { status, showText: true }) })
      ] }) }),
      currentDrilldownItem.children && currentDrilldownItem.children.length > 0 && /* @__PURE__ */ jsx(Card, { title: "\u5B50\u8D44\u6E90", style: { marginTop: 16 }, children: currentDrilldownItem.children.map((child) => /* @__PURE__ */ jsx(
        Card,
        {
          style: { marginBottom: 8 },
          hoverable: true,
          onClick: () => {
            navigate(`/drilldown?type=${child.type}&id=${child.id}`);
          },
          children: /* @__PURE__ */ jsxs(
            "div",
            {
              style: { display: "flex", justifyContent: "space-between", alignItems: "center" },
              children: [
                /* @__PURE__ */ jsxs("div", { children: [
                  /* @__PURE__ */ jsxs("strong", { children: [
                    getTypeName(child.type),
                    ": ",
                    child.name
                  ] }),
                  /* @__PURE__ */ jsxs("div", { style: { fontSize: "12px", color: "#666" }, children: [
                    "\u6210\u672C: \xA5",
                    child.cost.toLocaleString(),
                    " | \u6548\u7387: ",
                    child.efficiency,
                    "%"
                  ] })
                ] }),
                /* @__PURE__ */ jsx("div", { children: /* @__PURE__ */ jsx(
                  StatusIndicator,
                  {
                    status: child.efficiency < 50 ? "critical" : child.efficiency < 70 ? "warning" : "healthy"
                  }
                ) })
              ]
            }
          )
        },
        child.id
      )) })
    ] });
  };
  return /* @__PURE__ */ jsxs("div", { children: [
    /* @__PURE__ */ jsx(DrilldownNavigator, { onBack: handleBack, onHome: handleHome }),
    renderDrilldownContent()
  ] });
};
export default DrilldownPage;
