"use strict";
import { Fragment, jsx, jsxs } from "react/jsx-runtime";
import { useEffect } from "react";
import { Card, Statistic, Row, Col, Alert, Spin, Tabs } from "antd";
import { LoadingOutlined } from "@ant-design/icons";
import TrendChart from "@/components/TrendChart";
import { useAppStore } from "@/store";
const { TabPane } = Tabs;
const ROIDashboard = () => {
  const { roiTrends, loadingROI, errorROI, fetchROITrends, useMockData } = useAppStore();
  useEffect(() => {
    fetchROITrends();
  }, [fetchROITrends]);
  const renderSummaryStats = () => {
    if (!roiTrends || roiTrends.length === 0) {
      return null;
    }
    const latest = roiTrends[roiTrends.length - 1];
    const previous = roiTrends.length > 1 ? roiTrends[roiTrends.length - 2] : null;
    const valueChange = previous ? (latest.value - previous.value) / previous.value * 100 : 0;
    const costChange = previous ? (latest.cost - previous.cost) / previous.cost * 100 : 0;
    const efficiencyChange = previous ? latest.efficiency - previous.efficiency : 0;
    return /* @__PURE__ */ jsxs(Row, { gutter: [16, 16], style: { marginBottom: 16 }, children: [
      /* @__PURE__ */ jsx(Col, { xs: 24, sm: 12, md: 8, children: /* @__PURE__ */ jsx(Card, { children: /* @__PURE__ */ jsx(
        Statistic,
        {
          title: "\u5F53\u524D\u4EF7\u503C",
          value: latest.value,
          prefix: "\xA5",
          formatter: (value) => Number(value).toLocaleString(),
          valueStyle: { color: valueChange >= 0 ? "#52c41a" : "#ff4d4f" },
          suffix: previous && /* @__PURE__ */ jsxs(
            "span",
            {
              style: { fontSize: "12px", color: valueChange >= 0 ? "#52c41a" : "#ff4d4f" },
              children: [
                valueChange >= 0 ? "+" : "",
                valueChange.toFixed(2),
                "%"
              ]
            }
          )
        }
      ) }) }),
      /* @__PURE__ */ jsx(Col, { xs: 24, sm: 12, md: 8, children: /* @__PURE__ */ jsx(Card, { children: /* @__PURE__ */ jsx(
        Statistic,
        {
          title: "\u5F53\u524D\u6210\u672C",
          value: latest.cost,
          prefix: "\xA5",
          formatter: (value) => Number(value).toLocaleString(),
          valueStyle: { color: costChange <= 0 ? "#52c41a" : "#ff4d4f" },
          suffix: previous && /* @__PURE__ */ jsxs(
            "span",
            {
              style: { fontSize: "12px", color: costChange <= 0 ? "#52c41a" : "#ff4d4f" },
              children: [
                costChange <= 0 ? "" : "+",
                costChange.toFixed(2),
                "%"
              ]
            }
          )
        }
      ) }) }),
      /* @__PURE__ */ jsx(Col, { xs: 24, sm: 12, md: 8, children: /* @__PURE__ */ jsx(Card, { children: /* @__PURE__ */ jsx(
        Statistic,
        {
          title: "\u5F53\u524D\u6548\u7387\u5206",
          value: latest.efficiency,
          valueStyle: { color: efficiencyChange >= 0 ? "#52c41a" : "#ff4d4f" },
          suffix: /* @__PURE__ */ jsxs(
            "span",
            {
              style: { fontSize: "12px", color: efficiencyChange >= 0 ? "#52c41a" : "#ff4d4f" },
              children: [
                efficiencyChange >= 0 ? "+" : "",
                efficiencyChange.toFixed(2),
                "%"
              ]
            }
          )
        }
      ) }) })
    ] });
  };
  const renderCharts = () => {
    if (!roiTrends || roiTrends.length === 0) {
      return /* @__PURE__ */ jsx("div", { style: { textAlign: "center", padding: "40px" }, children: /* @__PURE__ */ jsx("p", { children: "\u6682\u65E0\u8D8B\u52BF\u6570\u636E" }) });
    }
    const thirtyDaysAgo = /* @__PURE__ */ new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const recentTrends = roiTrends.filter((trend) => {
      const trendDate = new Date(trend.date);
      return trendDate >= thirtyDaysAgo;
    });
    return /* @__PURE__ */ jsxs(Tabs, { defaultActiveKey: "1", children: [
      /* @__PURE__ */ jsx(TabPane, { tab: "\u4EF7\u503C\u4E0E\u6210\u672C\u8D8B\u52BF", children: /* @__PURE__ */ jsx(TrendChart, { data: recentTrends, showEfficiency: false, height: 400 }) }, "1"),
      /* @__PURE__ */ jsx(TabPane, { tab: "\u6548\u7387\u5206\u8D8B\u52BF", children: /* @__PURE__ */ jsx(TrendChart, { data: recentTrends, showEfficiency: true, height: 400 }) }, "2"),
      /* @__PURE__ */ jsx(TabPane, { tab: "\u5B8C\u6574\u8D8B\u52BF", children: /* @__PURE__ */ jsx(TrendChart, { data: roiTrends, showEfficiency: true, height: 400 }) }, "3")
    ] });
  };
  return /* @__PURE__ */ jsxs("div", { children: [
    /* @__PURE__ */ jsx("h2", { children: "ROI\u4EF7\u503C\u8FFD\u8E2A" }),
    useMockData && /* @__PURE__ */ jsx(Alert, { message: "\u5F53\u524D\u4F7F\u7528Mock\u6570\u636E", type: "info", style: { marginBottom: 16 } }),
    loadingROI ? /* @__PURE__ */ jsxs("div", { style: { textAlign: "center", padding: "40px" }, children: [
      /* @__PURE__ */ jsx(Spin, { indicator: /* @__PURE__ */ jsx(LoadingOutlined, { spin: true }) }),
      /* @__PURE__ */ jsx("p", { children: "\u52A0\u8F7DROI\u8D8B\u52BF\u4E2D..." })
    ] }) : errorROI ? /* @__PURE__ */ jsx(
      Alert,
      {
        message: "\u52A0\u8F7DROI\u8D8B\u52BF\u5931\u8D25",
        description: errorROI,
        type: "error",
        showIcon: true,
        style: { marginBottom: 16 }
      }
    ) : /* @__PURE__ */ jsxs(Fragment, { children: [
      renderSummaryStats(),
      /* @__PURE__ */ jsx(Card, { title: "\u8D8B\u52BF\u5206\u6790", children: renderCharts() })
    ] })
  ] });
};
export default ROIDashboard;
