"use strict";
import { create } from "zustand";
import { persist } from "zustand/middleware";
import { costService } from "@/services/costService";
import { mockApi } from "@/services/mockApi";
export const useAppStore = create()(
  persist(
    (set, get) => ({
      // 初始状态
      globalCostMetrics: null,
      loadingGlobalMetrics: false,
      errorGlobalMetrics: null,
      namespaceCosts: null,
      loadingNamespaceCosts: false,
      errorNamespaceCosts: null,
      currentDrilldownItem: null,
      drilldownPath: [],
      loadingDrilldown: false,
      errorDrilldown: null,
      sloStatus: null,
      loadingSLO: false,
      errorSLO: null,
      roiTrends: null,
      loadingROI: false,
      errorROI: null,
      useMockData: true,
      selectedNamespace: null,
      selectedNode: null,
      selectedWorkload: null,
      selectedPod: null,
      // Actions
      fetchGlobalCostMetrics: async () => {
        const { useMockData } = get();
        set({ loadingGlobalMetrics: true, errorGlobalMetrics: null });
        try {
          const data = useMockData ? await mockApi.getGlobalCostMetrics() : await costService.getGlobalCostMetrics();
          set({ globalCostMetrics: data, loadingGlobalMetrics: false });
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : "\u83B7\u53D6\u5168\u5C40\u6210\u672C\u6307\u6807\u5931\u8D25";
          set({ errorGlobalMetrics: errorMessage, loadingGlobalMetrics: false });
        }
      },
      fetchNamespaceCosts: async () => {
        const { useMockData } = get();
        set({ loadingNamespaceCosts: true, errorNamespaceCosts: null });
        try {
          const data = useMockData ? await mockApi.getNamespaceCosts() : await costService.getNamespaceCosts();
          set({ namespaceCosts: data, loadingNamespaceCosts: false });
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : "\u83B7\u53D6\u547D\u540D\u7A7A\u95F4\u6210\u672C\u5931\u8D25";
          set({ errorNamespaceCosts: errorMessage, loadingNamespaceCosts: false });
        }
      },
      fetchDrilldownData: async (type, id) => {
        const { useMockData, drilldownPath } = get();
        set({ loadingDrilldown: true, errorDrilldown: null });
        try {
          const data = useMockData ? await mockApi.getDrilldownData(type, id) : await costService.getDrilldownData(type, id);
          const newPath = [...drilldownPath, `${type}:${id}`];
          set({
            currentDrilldownItem: data,
            drilldownPath: newPath,
            loadingDrilldown: false
          });
          if (type === "namespace") {
            set({
              selectedNamespace: id,
              selectedNode: null,
              selectedWorkload: null,
              selectedPod: null
            });
          } else if (type === "node") {
            set({ selectedNode: id, selectedWorkload: null, selectedPod: null });
          } else if (type === "workload") {
            set({ selectedWorkload: id, selectedPod: null });
          } else if (type === "pod") {
            set({ selectedPod: id });
          }
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : "\u83B7\u53D6\u94BB\u53D6\u6570\u636E\u5931\u8D25";
          set({ errorDrilldown: errorMessage, loadingDrilldown: false });
        }
      },
      fetchSLOStatus: async () => {
        const { useMockData } = get();
        set({ loadingSLO: true, errorSLO: null });
        try {
          const data = useMockData ? await mockApi.getSLOStatus() : await costService.getSLOStatus();
          set({ sloStatus: data, loadingSLO: false });
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : "\u83B7\u53D6SLO\u72B6\u6001\u5931\u8D25";
          set({ errorSLO: errorMessage, loadingSLO: false });
        }
      },
      fetchROITrends: async () => {
        const { useMockData } = get();
        set({ loadingROI: true, errorROI: null });
        try {
          const data = useMockData ? await mockApi.getROITrends() : await costService.getROITrends();
          set({ roiTrends: data, loadingROI: false });
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : "\u83B7\u53D6ROI\u8D8B\u52BF\u5931\u8D25";
          set({ errorROI: errorMessage, loadingROI: false });
        }
      },
      setUseMockData: (useMock) => {
        set({ useMockData: useMock });
      },
      setSelectedNamespace: (namespace) => {
        set({ selectedNamespace: namespace });
      },
      setSelectedNode: (node) => {
        set({ selectedNode: node });
      },
      setSelectedWorkload: (workload) => {
        set({ selectedWorkload: workload });
      },
      setSelectedPod: (pod) => {
        set({ selectedPod: pod });
      },
      clearDrilldownPath: () => {
        set({
          drilldownPath: [],
          currentDrilldownItem: null,
          selectedNamespace: null,
          selectedNode: null,
          selectedWorkload: null,
          selectedPod: null
        });
      },
      resetErrors: () => {
        set({
          errorGlobalMetrics: null,
          errorNamespaceCosts: null,
          errorDrilldown: null,
          errorSLO: null,
          errorROI: null
        });
      }
    }),
    {
      name: "lighthouse-storage",
      partialize: (state) => ({
        useMockData: state.useMockData,
        selectedNamespace: state.selectedNamespace,
        selectedNode: state.selectedNode,
        selectedWorkload: state.selectedWorkload,
        selectedPod: state.selectedPod
      })
    }
  )
);
